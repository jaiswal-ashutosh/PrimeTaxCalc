<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrimeTaxCalc - India's Premier Tax Calculator FY 2024-25</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .calculator-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .calculator-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .card-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #2563eb;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        input, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f9fafb;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            min-width: 140px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        .results-panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            display: none;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .result-item {
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 15px;
            text-align: center;
            border-left: 4px solid #3b82f6;
        }

        .result-label {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
        }

        .breakdown-section {
            margin-top: 30px;
        }

        .breakdown-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #374151;
        }

        .breakdown-content {
            background: #f9fafb;
            border-radius: 10px;
            padding: 20px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        .deductions-section {
            margin-top: 20px;
            padding: 20px;
            background: #fef3c7;
            border-radius: 10px;
            border-left: 4px solid #f59e0b;
        }

        .regime-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .comparison-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            display: none;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }

        .regime-comparison {
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .new-regime {
            background: linear-gradient(135deg, #dcfdf7, #a7f3d0);
            border: 2px solid #10b981;
        }

        .old-regime {
            background: linear-gradient(135deg, #fef2f2, #fecaca);
            border: 2px solid #ef4444;
        }

        .recommendation {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #3b82f6;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .calculator-container {
                grid-template-columns: 1fr;
            }
            
            .comparison-grid {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .action-buttons {
                justify-content: center;
            }
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #dc2626;
            margin: 20px 0;
        }

        .success-message {
            background: #f0fdf4;
            color: #166534;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #16a34a;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üßÆ PrimeTaxCalc</h1>
            <p class="subtitle">India's Premier Income Tax Calculator for FY 2024-25</p>
        </header>

        <div class="calculator-container">
            <!-- Input Form -->
            <div class="calculator-card">
                <h2 class="card-title">
                    üìä Tax Calculator
                    <span id="regimeBadge" class="regime-badge">New Regime</span>
                </h2>

                <form id="taxForm">
                    <div class="form-group">
                        <label for="annualIncome">Annual Income (‚Çπ)</label>
                        <input type="text" id="annualIncome" placeholder="Enter your annual income">
                    </div>

                    <div class="form-group">
                        <label for="age">Age Category</label>
                        <select id="age">
                            <option value="below60">Below 60 years</option>
                            <option value="60to80">60-80 years</option>
                            <option value="above80">Above 80 years</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="regime">Tax Regime</label>
                        <select id="regime">
                            <option value="new">New Tax Regime (Default)</option>
                            <option value="old">Old Tax Regime</option>
                        </select>
                    </div>

                    <!-- Old Regime Deductions -->
                    <div id="oldRegimeDeductions" class="deductions-section" style="display: none;">
                        <h3>üìã Deductions (Old Regime Only)</h3>
                        
                        <div class="form-group">
                            <label for="section80C">Section 80C (Max ‚Çπ1,50,000)</label>
                            <input type="text" id="section80C" placeholder="PPF, ELSS, Life Insurance etc.">
                        </div>

                        <div class="form-group">
                            <label for="section80D">Section 80D (Health Insurance)</label>
                            <input type="text" id="section80D" placeholder="Health insurance premiums">
                        </div>

                        <div class="form-group">
                            <label for="hra">HRA Exemption</label>
                            <input type="text" id="hra" placeholder="House Rent Allowance exemption">
                        </div>

                        <div class="form-group">
                            <label for="otherDeductions">Other Deductions</label>
                            <input type="text" id="otherDeductions" placeholder="80E, 80G etc.">
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="calculateTax()">
                        Calculate Tax üöÄ
                    </button>
                </form>
            </div>

            <!-- Results Panel -->
            <div class="calculator-card">
                <h2 class="card-title">üí∞ Tax Summary</h2>
                
                <div id="resultsPanel">
                    <div class="results-grid">
                        <div class="result-item">
                            <div class="result-label">Gross Income</div>
                            <div class="result-value" id="grossIncome">‚Çπ0</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Total Deductions</div>
                            <div class="result-value" id="totalDeductions">‚Çπ0</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Taxable Income</div>
                            <div class="result-value" id="taxableIncome">‚Çπ0</div>
                        </div>
                        <div class="result-item" style="border-left-color: #dc2626;">
                            <div class="result-label">Income Tax</div>
                            <div class="result-value" id="incomeTax" style="color: #dc2626;">‚Çπ0</div>
                        </div>
                        <div class="result-item" style="border-left-color: #f59e0b;">
                            <div class="result-label">Cess (4%)</div>
                            <div class="result-value" id="cess" style="color: #f59e0b;">‚Çπ0</div>
                        </div>
                        <div class="result-item" style="border-left-color: #dc2626;">
                            <div class="result-label">Total Tax</div>
                            <div class="result-value" id="totalTax" style="color: #dc2626;">‚Çπ0</div>
                        </div>
                    </div>

                    <div class="breakdown-section">
                        <h3 class="breakdown-title">üìà Tax Slab Breakdown</h3>
                        <div class="breakdown-content" id="breakdownContent">
                            <p style="color: #64748b; text-align: center; padding: 1rem;">
                                üí° Enter your annual income to see detailed tax breakdown
                            </p>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="compareRegimes()">
                            Compare Regimes ‚öñÔ∏è
                        </button>
                        <button class="btn btn-primary" onclick="downloadReport()">
                            Download Report üìÑ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparison Section -->
        <div id="comparisonSection" class="comparison-section">
            <h2 class="card-title">‚öñÔ∏è Regime Comparison</h2>
            
            <div class="comparison-grid">
                <div class="regime-comparison new-regime">
                    <h3>New Tax Regime</h3>
                    <p><strong>Tax:</strong> <span id="newRegimeTax">‚Çπ0</span></p>
                    <p><strong>Net Income:</strong> <span id="newRegimeNet">‚Çπ0</span></p>
                    <p><strong>Savings:</strong> <span id="newSavings">-</span></p>
                </div>
                
                <div class="regime-comparison old-regime">
                    <h3>Old Tax Regime</h3>
                    <p><strong>Tax:</strong> <span id="oldRegimeTax">‚Çπ0</span></p>
                    <p><strong>Net Income:</strong> <span id="oldRegimeNet">‚Çπ0</span></p>
                    <p><strong>Savings:</strong> <span id="oldSavings">-</span></p>
                </div>
            </div>
            
            <div id="recommendation" class="recommendation">
                <h4>üí° Calculate tax first to see recommendation</h4>
            </div>
        </div>
    </div>

    <script>
        // Tax slabs for FY 2024-25 - Fixed key mapping
        const TAX_SLABS = {
            new: {
                below60: [
                    { min: 0, max: 300000, rate: 0 },
                    { min: 300001, max: 700000, rate: 5 },
                    { min: 700001, max: 1000000, rate: 10 },
                    { min: 1000001, max: 1200000, rate: 15 },
                    { min: 1200001, max: 1500000, rate: 20 },
                    { min: 1500001, max: Infinity, rate: 30 }
                ],
                '60to80': [
                    { min: 0, max: 300000, rate: 0 },
                    { min: 300001, max: 700000, rate: 5 },
                    { min: 700001, max: 1000000, rate: 10 },
                    { min: 1000001, max: 1200000, rate: 15 },
                    { min: 1200001, max: 1500000, rate: 20 },
                    { min: 1500001, max: Infinity, rate: 30 }
                ],
                above80: [
                    { min: 0, max: 500000, rate: 0 },
                    { min: 500001, max: 700000, rate: 5 },
                    { min: 700001, max: 1000000, rate: 10 },
                    { min: 1000001, max: 1200000, rate: 15 },
                    { min: 1200001, max: 1500000, rate: 20 },
                    { min: 1500001, max: Infinity, rate: 30 }
                ]
            },
            old: {
                below60: [
                    { min: 0, max: 250000, rate: 0 },
                    { min: 250001, max: 500000, rate: 5 },
                    { min: 500001, max: 1000000, rate: 20 },
                    { min: 1000001, max: Infinity, rate: 30 }
                ],
                '60to80': [
                    { min: 0, max: 300000, rate: 0 },
                    { min: 300001, max: 500000, rate: 5 },
                    { min: 500001, max: 1000000, rate: 20 },
                    { min: 1000001, max: Infinity, rate: 30 }
                ],
                above80: [
                    { min: 0, max: 500000, rate: 0 },
                    { min: 500001, max: 1000000, rate: 20 },
                    { min: 1000001, max: Infinity, rate: 30 }
                ]
            }
        };

        const STANDARD_DEDUCTION = {
            new: 75000,
            old: 0
        };

        let calculationTimeout;
        window.currentCalculation = null;

        // Initialize the calculator
        document.addEventListener('DOMContentLoaded', function() {
            console.log('PrimeTaxCalc initialized successfully! üöÄ');
            setupEventListeners();
            initializeForm();
        });

        function setupEventListeners() {
            // Regime change listener
            const regimeSelect = document.getElementById('regime');
            if (regimeSelect) {
                regimeSelect.addEventListener('change', handleRegimeChange);
            }
            
            // Real-time calculation
            const incomeInput = document.getElementById('annualIncome');
            if (incomeInput) {
                incomeInput.addEventListener('input', function() {
                    clearTimeout(calculationTimeout);
                    calculationTimeout = setTimeout(calculateTax, 500);
                });
            }
            
            // Other input listeners
            const inputs = ['age', 'section80C', 'section80D', 'hra', 'otherDeductions'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', function() {
                        clearTimeout(calculationTimeout);
                        calculationTimeout = setTimeout(calculateTax, 300);
                    });
                    
                    // Format number inputs
                    if (id !== 'age') {
                        element.addEventListener('input', formatNumberInput);
                        element.addEventListener('focus', function() {
                            this.value = this.value.replace(/,/g, '');
                        });
                        element.addEventListener('blur', function() {
                            if (this.value) {
                                this.value = formatNumber(parseFloat(this.value.replace(/,/g, '') || 0));
                            }
                        });
                    }
                }
            });
        }

        function initializeForm() {
            handleRegimeChange();
        }

        function handleRegimeChange() {
            const regime = document.getElementById('regime')?.value || 'new';
            const deductionsSection = document.getElementById('oldRegimeDeductions');
            const regimeBadge = document.getElementById('regimeBadge');
            
            if (deductionsSection) {
                deductionsSection.style.display = regime === 'old' ? 'block' : 'none';
            }
            
            if (regimeBadge) {
                if (regime === 'old') {
                    regimeBadge.textContent = 'Old Regime';
                    regimeBadge.style.background = 'linear-gradient(135deg, #dc2626, #b91c1c)';
                } else {
                    regimeBadge.textContent = 'New Regime';
                    regimeBadge.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                }
            }
            
            // Recalculate if income exists
            const income = parseFloat(getCleanValue('annualIncome'));
            if (income > 0) {
                setTimeout(calculateTax, 100);
            }
        }

        function formatNumberInput(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            if (value) {
                e.target.value = parseInt(value).toLocaleString('en-IN');
            }
        }

        function getCleanValue(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return 0;
            return element.value.replace(/,/g, '') || 0;
        }

        function calculateTax() {
            try {
                const income = parseFloat(getCleanValue('annualIncome'));
                const age = document.getElementById('age')?.value || 'below60';
                const regime = document.getElementById('regime')?.value || 'new';
                
                if (income <= 0) {
                    showEmptyResults();
                    return;
                }
                
                // Show loading state
                showLoadingState(true);
                
                // Perform calculation
                const result = performTaxCalculation(income, age, regime);
                
                // Display results
                setTimeout(() => {
                    displayResults(result);
                    showLoadingState(false);
                }, 200);
                
            } catch (error) {
                console.error('Error in calculateTax:', error);
                showLoadingState(false);
                showErrorMessage('Calculation error. Please check your inputs and try again.');
            }
        }

        function performTaxCalculation(income, age, regime) {
            try {
                let totalDeductions = 0;
                
                if (regime === 'new') {
                    totalDeductions = STANDARD_DEDUCTION.new;
                } else {
                    const section80C = Math.min(parseFloat(getCleanValue('section80C')), 150000);
                    const section80D = parseFloat(getCleanValue('section80D'));
                    const hra = parseFloat(getCleanValue('hra'));
                    const otherDeductions = parseFloat(getCleanValue('otherDeductions'));
                    
                    totalDeductions = section80C + section80D + hra + otherDeductions;
                }
                
                const taxableIncome = Math.max(0, income - totalDeductions);
                
                // Map age categories properly
                let ageCategory = age;
                if (age === '60to80') {
                    ageCategory = '60to80';
                } else if (age === 'above80') {
                    ageCategory = 'above80';
                } else {
                    ageCategory = 'below60';
                }
                
                const slabs = TAX_SLABS[regime]?.[ageCategory];
                
                if (!slabs) {
                    console.error('Debug info:', { regime, age, ageCategory, availableSlabs: Object.keys(TAX_SLABS[regime] || {}) });
                    throw new Error(`Invalid regime (${regime}) or age category (${ageCategory})`);
                }
                
                let tax = 0;
                const breakdown = [];
                
                for (const slab of slabs) {
                    if (taxableIncome > slab.min) {
                        const applicableIncome = Math.min(taxableIncome, slab.max) - slab.min;
                        const slabTax = (applicableIncome * slab.rate) / 100;
                        tax += slabTax;
                        
                        if (slabTax > 0) {
                            breakdown.push({
                                range: slab.max === Infinity ? 
                                    `‚Çπ${formatNumber(slab.min)}+ @ ${slab.rate}%` : 
                                    `‚Çπ${formatNumber(slab.min)} - ‚Çπ${formatNumber(slab.max)} @ ${slab.rate}%`,
                                tax: slabTax,
                                rate: slab.rate
                            });
                        }
                    }
                }
                
                const cess = tax * 0.04;
                const totalTax = tax + cess;
                const netIncome = income - totalTax;
                
                return {
                    grossIncome: income,
                    totalDeductions: totalDeductions,
                    taxableIncome: taxableIncome,
                    incomeTax: tax,
                    cess: cess,
                    totalTax: totalTax,
                    netIncome: netIncome,
                    breakdown: breakdown,
                    regime: regime,
                    age: age
                };
                
            } catch (error) {
                console.error('Error in performTaxCalculation:', error);
                throw error;
            }
        }

        function displayResults(result) {
            try {
                // Update summary values
                document.getElementById('grossIncome').textContent = `‚Çπ${formatNumber(result.grossIncome)}`;
                document.getElementById('totalDeductions').textContent = `‚Çπ${formatNumber(result.totalDeductions)}`;
                document.getElementById('taxableIncome').textContent = `‚Çπ${formatNumber(result.taxableIncome)}`;
                document.getElementById('incomeTax').textContent = `‚Çπ${formatNumber(result.incomeTax)}`;
                document.getElementById('cess').textContent = `‚Çπ${formatNumber(result.cess)}`;
                document.getElementById('totalTax').textContent = `‚Çπ${formatNumber(result.totalTax)}`;
                
                // Update tax breakdown
                const breakdownContent = document.getElementById('breakdownContent');
                if (breakdownContent) {
                    breakdownContent.innerHTML = '';
                    
                    if (result.breakdown.length === 0) {
                        breakdownContent.innerHTML = '<p style="color: #10b981; font-weight: 500; padding: 1rem; text-align: center;">üéâ No tax applicable - Income below taxable limit!</p>';
                    } else {
                        result.breakdown.forEach(item => {
                            const breakdownItem = document.createElement('div');
                            breakdownItem.className = 'breakdown-item';
                            breakdownItem.innerHTML = `
                                <span>${item.range}</span>
                                <span style="font-weight: 600; color: #dc2626;">‚Çπ${formatNumber(item.tax)}</span>
                            `;
                            breakdownContent.appendChild(breakdownItem);
                        });
                    }
                }
                
                // Store results globally
                window.currentCalculation = result;
                
                console.log('Results displayed successfully:', result);
                
            } catch (error) {
                console.error('Error in displayResults:', error);
                showErrorMessage('Error displaying results. Please try again.');
            }
        }

        function showLoadingState(show) {
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => {
                if (show) {
                    btn.classList.add('loading');
                    btn.disabled = true;
                } else {
                    btn.classList.remove('loading');
                    btn.disabled = false;
                }
            });
        }

        function showEmptyResults() {
            const fields = ['grossIncome', 'totalDeductions', 'taxableIncome', 'incomeTax', 'cess', 'totalTax'];
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) element.textContent = '‚Çπ0';
            });
            
            const breakdownContent = document.getElementById('breakdownContent');
            if (breakdownContent) {
                breakdownContent.innerHTML = '<p style="color: #64748b; padding: 1rem; text-align: center;">üí° Enter your annual income to see detailed tax breakdown</p>';
            }
        }

        function showErrorMessage(message) {
            const breakdownContent = document.getElementById('breakdownContent');
            if (breakdownContent) {
                breakdownContent.innerHTML = `<p style="color: #dc2626; padding: 1rem; text-align: center;">‚ö†Ô∏è ${message}</p>`;
            }
        }

        function compareRegimes() {
            try {
                const income = parseFloat(getCleanValue('annualIncome'));
                const age = document.getElementById('age')?.value || 'below60';
                
                if (income <= 0) {
                    alert('Please enter your annual income first');
                    return;
                }
                
                // Calculate for both regimes
                const newRegimeResult = performTaxCalculation(income, age, 'new');
                const oldRegimeResult = performTaxCalculation(income, age, 'old');
                
                // Display comparison
                document.getElementById('newRegimeTax').textContent = `‚Çπ${formatNumber(newRegimeResult.totalTax)}`;
                document.getElementById('oldRegimeTax').textContent = `‚Çπ${formatNumber(oldRegimeResult.totalTax)}`;
                document.getElementById('newRegimeNet').textContent = `‚Çπ${formatNumber(newRegimeResult.netIncome)}`;
                document.getElementById('oldRegimeNet').textContent = `‚Çπ${formatNumber(oldRegimeResult.netIncome)}`;
                
                // Calculate savings
                const newSavings = oldRegimeResult.totalTax - newRegimeResult.totalTax;
                const oldSavings = newRegimeResult.totalTax - oldRegimeResult.totalTax;
                
                document.getElementById('newSavings').textContent = newSavings > 0 ? 
                    `‚Çπ${formatNumber(newSavings)} saved` : 
                    newSavings < 0 ? `‚Çπ${formatNumber(Math.abs(newSavings))} extra` : 'Same';
                    
                document.getElementById('oldSavings').textContent = oldSavings > 0 ? 
                    `‚Çπ${formatNumber(oldSavings)} saved` : 
                    oldSavings < 0 ? `‚Çπ${formatNumber(Math.abs(oldSavings))} extra` : 'Same';
                
                // Show recommendation
                const recommendation = document.getElementById('recommendation');
                if (recommendation) {
                    if (newRegimeResult.totalTax < oldRegimeResult.totalTax) {
                        recommendation.innerHTML = `
                            <h4 style="color: #10b981; margin-bottom: 0.5rem;">üí° Recommendation: Choose New Tax Regime</h4>
                            <p>You can save ‚Çπ${formatNumber(newSavings)} annually by choosing the new tax regime.</p>
                        `;
                    } else if (oldRegimeResult.totalTax < newRegimeResult.totalTax) {
                        recommendation.innerHTML = `
                            <h4 style="color: #dc2626; margin-bottom: 0.5rem;">üí° Recommendation: Choose Old Tax Regime</h4>
                            <p>You can save ‚Çπ${formatNumber(oldSavings)} annually by choosing the old tax regime with deductions.</p>
                        `;
                    } else {
                        recommendation.innerHTML = `
                            <h4 style="color: #2563eb; margin-bottom: 0.5rem;">üí° Both regimes result in same tax</h4>
                            <p>You can choose either regime as both result in the same tax liability.</p>
                        `;
                    }
                }
                
                // Show comparison section
                const comparisonSection = document.getElementById('comparisonSection');
                if (comparisonSection) {
                    comparisonSection.style.display = 'block';
                    comparisonSection.scrollIntoView({ behavior: 'smooth' });
                }
                
            } catch (error) {
                console.error('Error in compareRegimes:', error);
                alert('Error comparing regimes. Please try again.');
            }
        }

        function downloadReport() {
            try {
                if (!window.currentCalculation) {
                    alert('Please calculate tax first');
                    return;
                }
                
                const result = window.currentCalculation;
                const currentDate = new Date().toLocaleDateString('en-IN');
                
                let content = `INCOME TAX CALCULATION REPORT - FY 2024-25
=====================================================

Generated by: PrimeTaxCalc.com
Date: ${currentDate}
Tax Regime: ${result.regime.toUpperCase()} REGIME

INCOME DETAILS:
--------------
Gross Annual Income: ‚Çπ${formatNumber(result.grossIncome)}
Total Deductions: ‚Çπ${formatNumber(result.totalDeductions)}
Taxable Income: ‚Çπ${formatNumber(result.taxableIncome)}

TAX CALCULATION:
---------------
Income Tax: ‚Çπ${formatNumber(result.incomeTax)}
Health & Education Cess (4%): ‚Çπ${formatNumber(result.cess)}
Total Tax Liability: ‚Çπ${formatNumber(result.totalTax)}
Net Income After Tax: ‚Çπ${formatNumber(result.netIncome)}

TAX SLAB BREAKDOWN:
------------------`;

                if (result.breakdown && result.breakdown.length > 0) {
                    result.breakdown.forEach(item => {
                        content += `\n${item.range}: ‚Çπ${formatNumber(item.tax)}`;
                    });
                } else {
                    content += '\nNo tax applicable - Income below taxable limit';
                }

                content += `\n\nDISCLAIMER:
-----------
This calculation is for reference only. Please consult a qualified 
tax professional for accurate tax planning and advice.

Visit PrimeTaxCalc.com for latest tax calculations.
        `;
                
                // Create and download file
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `PrimeTaxCalc-Report-${new Date().getFullYear()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                alert('Tax report downloaded successfully! üìÑ');
                
            } catch (error) {
                console.error('Error in downloadReport:', error);
                alert('Error generating report. Please try again.');
            }
        }

        // Utility functions
        function formatNumber(num) {
            if (isNaN(num) || num === null || num === undefined) return '0';
            return new Intl.NumberFormat('en-IN').format(Math.round(num));
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter to calculate
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                calculateTax();
            }
            
            // Escape to clear form
            if (e.key === 'Escape') {
                const incomeInput = document.getElementById('annualIncome');
                if (incomeInput && incomeInput === document.activeElement) {
                    incomeInput.value = '';
                    showEmptyResults();
                }
            }
        });

        // Input validation
        function validateInput(input, maxValue = null) {
            let value = input.value.replace(/[^0-9]/g, '');
            
            if (maxValue && parseInt(value) > maxValue) {
                value = maxValue.toString();
                alert(`Maximum allowed value is ‚Çπ${formatNumber(maxValue)}`);
            }
            
            return value;
        }

        // Enhanced input formatting
        document.addEventListener('DOMContentLoaded', function() {
            // Add input validation for section 80C
            const section80CInput = document.getElementById('section80C');
            if (section80CInput) {
                section80CInput.addEventListener('blur', function() {
                    const value = parseFloat(this.value.replace(/,/g, '') || 0);
                    if (value > 150000) {
                        this.value = formatNumber(150000);
                        alert('Section 80C deduction is capped at ‚Çπ1,50,000');
                    }
                });
            }
        });

        // Print functionality
        function printResults() {
            if (!window.currentCalculation) {
                alert('Please calculate tax first');
                return;
            }
            
            window.print();
        }

        // Add smooth scrolling for better UX
        function smoothScroll(target) {
            const element = document.getElementById(target);
            if (element) {
                element.scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }

        // Success message for calculations
        function showSuccessMessage(message) {
            const existingMessage = document.querySelector('.success-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.innerHTML = `‚úÖ ${message}`;
            
            const container = document.querySelector('.container');
            container.insertBefore(successDiv, container.firstChild);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Enhanced error handling
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            showErrorMessage('An unexpected error occurred. Please refresh the page and try again.');
        });

        // Auto-save functionality using sessionStorage
        function autoSave() {
            try {
                const formData = {
                    annualIncome: getCleanValue('annualIncome'),
                    age: document.getElementById('age')?.value || 'below60',
                    regime: document.getElementById('regime')?.value || 'new',
                    section80C: getCleanValue('section80C'),
                    section80D: getCleanValue('section80D'),
                    hra: getCleanValue('hra'),
                    otherDeductions: getCleanValue('otherDeductions')
                };
                
                sessionStorage.setItem('primetaxcalc_formdata', JSON.stringify(formData));
            } catch (error) {
                console.log('Auto-save error:', error);
            }
        }

        function autoRestore() {
            try {
                const savedData = sessionStorage.getItem('primetaxcalc_formdata');
                if (savedData) {
                    const formData = JSON.parse(savedData);
                    
                    Object.keys(formData).forEach(key => {
                        const element = document.getElementById(key);
                        if (element && formData[key]) {
                            if (key === 'annualIncome' || key.includes('section') || key === 'hra' || key === 'otherDeductions') {
                                element.value = formatNumber(parseFloat(formData[key]));
                            } else {
                                element.value = formData[key];
                            }
                        }
                    });
                    
                    handleRegimeChange();
                    
                    // Auto-calculate if income exists
                    if (formData.annualIncome > 0) {
                        setTimeout(calculateTax, 500);
                    }
                }
            } catch (error) {
                console.log('Auto-restore error:', error);
            }
        }

        // Add auto-save listeners
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(autoRestore, 100);
            
            const inputs = ['annualIncome', 'age', 'regime', 'section80C', 'section80D', 'hra', 'otherDeductions'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', autoSave);
                    element.addEventListener('input', debounce(autoSave, 1000));
                }
            });
        });

        console.log('üöÄ PrimeTaxCalc Enhanced Calculator Loaded Successfully!');
        console.log('üìä Features: Real-time calculation, Auto-save, Regime comparison, Report download');
    </script>
</body>
</html>
